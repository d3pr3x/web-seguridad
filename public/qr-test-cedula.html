<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test QR cédula capturada</title>
    <style>
        body { font-family: system-ui, sans-serif; max-width: 640px; margin: 1rem auto; padding: 0 1rem; }
        h1 { font-size: 1.1rem; }
        #preview { max-width: 100%; max-height: 280px; display: block; margin: 0.5rem 0; border: 1px solid #ccc; }
        #log { white-space: pre-wrap; font-size: 12px; background: #1e1e1e; color: #d4d4d4; padding: 0.75rem; border-radius: 6px; max-height: 320px; overflow-y: auto; }
        #log .ok { color: #4ec9b0; }
        #log .err { color: #f48771; }
        button { margin-top: 0.5rem; padding: 0.5rem 1rem; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Test: decodificar QR en imagen de cédula</h1>
    <p>Imagen: <code>/cedula-captura-test.png</code></p>
    <img id="preview" src="/cedula-captura-test.png" alt="Cédula" crossorigin="anonymous">
    <button type="button" id="btn">Decodificar con jsQR + recortes</button>
    <div id="log"></div>

    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script>
        var logEl = document.getElementById('log');
        var img = document.getElementById('preview');

        function log(msg, isOk) {
            var span = document.createElement('span');
            span.className = isOk !== undefined ? (isOk ? 'ok' : 'err') : '';
            span.textContent = msg + '\n';
            logEl.appendChild(span);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function canvasCropLeft(src, frac) {
            var c = document.createElement('canvas');
            var sw = src.width, sh = src.height;
            c.width = Math.max(1, Math.round(sw * frac));
            c.height = sh;
            var ctx = c.getContext('2d');
            ctx.drawImage(src, 0, 0, c.width, sh, 0, 0, c.width, sh);
            return c;
        }

        function canvasContrast(src) {
            var c = document.createElement('canvas');
            c.width = src.width;
            c.height = src.height;
            var ctx = src.getContext('2d');
            var img = ctx.getImageData(0, 0, c.width, c.height);
            var d = img.data;
            var lums = [];
            for (var i = 0; i < d.length; i += 4)
                lums.push(0.299*d[i]+0.587*d[i+1]+0.114*d[i+2]);
            lums.sort(function(a,b){ return a-b; });
            var p2 = lums[Math.floor(lums.length*0.02)]||0, p98 = lums[Math.floor(lums.length*0.98)]||255, span = p98-p2||1;
            for (i = 0; i < d.length; i += 4) {
                var L = 0.299*d[i]+0.587*d[i+1]+0.114*d[i+2];
                var v = Math.round((L-p2)*255/span); v = v<0?0:v>255?255:v;
                d[i]=d[i+1]=d[i+2]=v;
            }
            c.getContext('2d').putImageData(img, 0, 0);
            return c;
        }

        function decodeJsQR(canvas) {
            try {
                var ctx = canvas.getContext('2d');
                var id = ctx.getImageData(0, 0, canvas.width, canvas.height);
                return jsQR(id.data, id.width, id.height, { inversionAttempts: 'attemptBoth' });
            } catch (e) { return null; }
        }

        img.onload = function() {
            document.getElementById('btn').addEventListener('click', function() {
                logEl.innerHTML = '';
                var w = img.naturalWidth || img.width, h = img.naturalHeight || img.height;
                log('Imagen: ' + w + '×' + h);

                var c = document.createElement('canvas');
                c.width = w;
                c.height = h;
                c.getContext('2d').drawImage(img, 0, 0);

                var code = decodeJsQR(c);
                if (code) { log('OK (completa): ' + code.data, true); return; }
                log('Completa: no QR');

                var cLeft = canvasCropLeft(c, 0.4);
                code = decodeJsQR(cLeft);
                if (code) { log('OK (recorte izq. 40%): ' + code.data, true); return; }
                log('Recorte 40%: no QR');

                var cLeft35 = canvasCropLeft(c, 0.35);
                code = decodeJsQR(cLeft35);
                if (code) { log('OK (recorte izq. 35%): ' + code.data, true); return; }
                log('Recorte 35%: no QR');

                code = decodeJsQR(canvasContrast(c));
                if (code) { log('OK (contraste completa): ' + code.data, true); return; }
                log('Contraste completa: no QR');

                code = decodeJsQR(canvasContrast(cLeft));
                if (code) { log('OK (contraste + recorte 40%): ' + code.data, true); return; }
                log('Contraste+recorte: no QR');

                var c2x = document.createElement('canvas');
                c2x.width = Math.min(w*2, 1920);
                c2x.height = Math.min(h*2, 1920);
                var ctx2 = c2x.getContext('2d');
                ctx2.imageSmoothingEnabled = true;
                ctx2.imageSmoothingQuality = 'high';
                ctx2.drawImage(c, 0, 0, w, h, 0, 0, c2x.width, c2x.height);
                code = decodeJsQR(c2x);
                if (code) { log('OK (2x): ' + code.data, true); return; }
                log('2x: no QR');

                var cLeft2x = document.createElement('canvas');
                cLeft2x.width = Math.min(cLeft.width*2, 1920);
                cLeft2x.height = Math.min(cLeft.height*2, 1920);
                var ctxLeft2 = cLeft2x.getContext('2d');
                ctxLeft2.imageSmoothingEnabled = true;
                ctxLeft2.drawImage(cLeft, 0, 0, cLeft.width, cLeft.height, 0, 0, cLeft2x.width, cLeft2x.height);
                code = decodeJsQR(cLeft2x);
                if (code) { log('OK (recorte 40% + 2x): ' + code.data, true); return; }
                log('Recorte 40%+2x: no QR');

                log('No se encontró QR con jsQR en ninguna variante.', false);
            });
        };
    </script>
</body>
</html>
